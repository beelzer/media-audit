name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/docs.yml'
      - '.github/workflows/release.yml'
      - '.github/workflows/codeql.yml'
      - 'mkdocs.yml'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/docs.yml'
      - '.github/workflows/release.yml'
      - '.github/workflows/codeql.yml'
      - 'mkdocs.yml'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Enable debug logging'
        required: false
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write
  actions: read

env:
  PYTHON_VERSION: '3.13'
  UV_VERSION: '0.4.18'
  UV_CACHE_DIR: ~/.cache/uv
  PIP_CACHE_DIR: ~/.cache/pip
  PRE_COMMIT_HOME: ~/.cache/pre-commit
  PYTHONUNBUFFERED: '1'
  FORCE_COLOR: '1'

jobs:
  # ============================================================================
  # 🚀 Setup Job - Prepare dependencies and cache for other jobs
  # ============================================================================

  setup-environment:
    name: 📦 Setup Environment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      uv-cache-hit: ${{ steps.uv-cache.outputs.cache-hit }}
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: 🔑 Generate cache key
        id: cache-key
        run: |
          echo "key=deps-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('**/pyproject.toml', '**/uv.lock') }}" >> "$GITHUB_OUTPUT"

      - name: 🐍 Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 📦 Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: 💾 Cache uv environment
        id: uv-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
            .venv
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            deps-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

      - name: 🔧 Install all dependencies
        if: steps.uv-cache.outputs.cache-hit != 'true'
        run: |
          uv sync --frozen --all-extras
          echo "Dependencies installed and cached"

      - name: 📊 Verify installation
        run: |
          echo "::group::Installed packages"
          uv pip list
          echo "::endgroup::"

  # ============================================================================
  # 🎯 Quality Gates - Using Matrix Strategy for Parallel Execution
  # ============================================================================

  quality-checks:
    name: ${{ matrix.check.emoji }} ${{ matrix.check.name }}
    needs: setup-environment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        check:
          - id: ruff-lint
            name: Ruff Linting
            command: ruff check src/ tests/ --output-format=github
            emoji: 🎨
          - id: ruff-format
            name: Ruff Formatting
            command: ruff format --check src/ tests/ --diff
            emoji: 🖌️
          - id: mypy
            name: Type Checking
            command: mypy src/ --show-column-numbers --show-error-context --pretty
            emoji: 🔍
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v5

      - name: 🐍 Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 📦 Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: 💾 Restore cached environment
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
            .venv
          key: ${{ needs.setup-environment.outputs.cache-key }}
          restore-keys: |
            deps-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

      - name: 🔧 Ensure dependencies
        run: |
          if [ ! -d ".venv" ]; then
            uv sync --frozen --all-extras
          fi

      - name: ${{ matrix.check.emoji }} Run ${{ matrix.check.name }}
        id: check
        run: |
          echo "::group::${{ matrix.check.name }} output"
          uv run ${{ matrix.check.command }}
          echo "::endgroup::"

      - name: 📊 Generate report for mypy
        if: matrix.check.id == 'mypy' && failure()
        run: |
          uv run mypy src/ --html-report mypy-report --any-exprs-report mypy-report || true

      - name: 📤 Upload artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.check.id }}-results
          path: |
            mypy-report/
            .ruff_cache/
          if-no-files-found: ignore
          retention-days: 3

  # ============================================================================
  # 🛡️ Security Scanning - Combined into Single Job with Parallel Steps
  # ============================================================================

  security-scan:
    name: 🛡️ Security Analysis
    needs: setup-environment
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Required for secrets detection

      - name: 🐍 Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 📦 Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: 💾 Restore cached environment
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
            .venv
          key: ${{ needs.setup-environment.outputs.cache-key }}
          restore-keys: |
            deps-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

      - name: 💾 Cache security tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.local/bin
          key: security-tools-${{ runner.os }}-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            security-tools-${{ runner.os }}-

      - name: 🔧 Install security tools
        run: |
          # Ensure dependencies
          if [ ! -d ".venv" ]; then
            uv sync --frozen --all-extras
          fi
          # Install additional security tools
          pip install --user detect-secrets pip-audit

      - name: 🔒 Run Bandit security scan
        id: bandit
        run: |
          echo "::group::Bandit security analysis"
          uv run bandit -r src/ -ll -f json -o bandit-report.json || true
          uv run bandit -r src/ -ll
          echo "::endgroup::"

      - name: 🔐 Scan for secrets
        id: secrets
        run: |
          echo "::group::Secrets detection"
          detect-secrets scan --baseline .secrets.baseline
          if detect-secrets scan --baseline .secrets.baseline | grep -q "no secrets detected"; then
            echo "✅ No secrets detected"
          else
            echo "⚠️ Potential secrets detected - please review .secrets.baseline"
          fi
          echo "::endgroup::"

      - name: 🛡️ Check dependencies for vulnerabilities
        id: dependencies
        run: |
          echo "::group::Dependency vulnerability scan"
          uv pip compile pyproject.toml -o requirements.txt
          pip-audit -r requirements.txt --desc || true
          echo "::endgroup::"

      - name: 📊 Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            requirements.txt
          retention-days: 30

  # ============================================================================
  # 🧪 Testing Matrix - Can run in parallel with quality checks
  # ============================================================================

  test-matrix:
    name: 🧪${{ matrix.os-emoji }} ${{ matrix.os-name }} • ${{ matrix.arch }} • Py${{ matrix.python }}
    needs: setup-environment  # Only needs setup, not quality checks
    strategy:
      fail-fast: false
      matrix:
        include:
          # x86_64 platforms
          - os: ubuntu-latest
            os-name: Linux
            os-emoji: 🐧
            arch: x64
            python: '3.13'
            coverage: true
          - os: windows-latest
            os-name: Windows
            os-emoji: 🪟
            arch: x64
            python: '3.13'
            coverage: false
          - os: macos-13
            os-name: macOS
            os-emoji: 🍎
            arch: x64
            python: '3.13'
            coverage: false
          # ARM platforms
          - os: macos-latest
            os-name: macOS
            os-emoji: 🍎
            arch: arm64
            python: '3.13'
            coverage: false
            skip-ffmpeg-action: true
          - os: ubuntu-24.04-arm
            os-name: Linux
            os-emoji: 🐧
            arch: arm64
            python: '3.13'
            coverage: false
            skip-ffmpeg-action: true
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v5

      - name: 🐍 Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: 📦 Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: 💾 Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
            ~/.cache/pip
            ~/Library/Caches/pip
            ~\AppData\Local\pip\Cache
          key: pip-${{ matrix.os }}-${{ matrix.arch }}-py${{ matrix.python }}-${{ hashFiles('**/pyproject.toml', '**/uv.lock') }}
          restore-keys: |
            pip-${{ matrix.os }}-${{ matrix.arch }}-py${{ matrix.python }}-
            pip-${{ matrix.os }}-${{ matrix.arch }}-

      - name: 💾 Cache test data
        uses: actions/cache@v4
        with:
          path: |
            tests/.pytest_cache
            .coverage
            htmlcov
          key: test-cache-${{ matrix.os }}-${{ matrix.arch }}-py${{ matrix.python }}-${{ hashFiles('tests/**/*.py', 'src/**/*.py') }}
          restore-keys: |
            test-cache-${{ matrix.os }}-${{ matrix.arch }}-py${{ matrix.python }}-
            test-cache-${{ matrix.os }}-${{ matrix.arch }}-

      - name: 🎥 Setup FFmpeg (via Action)
        if: matrix.skip-ffmpeg-action != true
        uses: FedericoCarboni/setup-ffmpeg@v3
        id: setup-ffmpeg
        with:
          ffmpeg-version: release
          github-token: ${{ github.token }}

      - name: 🎥 Setup FFmpeg (macOS ARM via Homebrew)
        if: matrix.os == 'macos-latest'
        run: |
          brew install ffmpeg
          echo "FFmpeg installed via Homebrew for ARM64"
          ffmpeg -version
          ffprobe -version

      - name: 🎥 Setup FFmpeg (Linux ARM via apt)
        if: matrix.os == 'ubuntu-24.04-arm'
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          echo "FFmpeg installed via apt for ARM64"
          ffmpeg -version
          ffprobe -version

      - name: 🔧 Install dependencies
        run: uv sync --frozen --all-extras

      - name: 🧪 Run tests with coverage
        if: matrix.coverage
        shell: bash
        run: |
          echo "::group::Test execution with coverage"
          uv run pytest tests/ \
            --cov=src/media_audit \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing:skip-covered \
            --junitxml=junit.xml \
            -v
          echo "::endgroup::"

      - name: 🧪 Run tests without coverage
        if: '!matrix.coverage'
        shell: bash
        run: |
          echo "::group::Test execution"
          uv run pytest tests/ \
            --junitxml=junit.xml \
            -v
          echo "::endgroup::"

      - name: 📊 Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.arch }}-py${{ matrix.python }}
          path: |
            junit.xml
            htmlcov/
            coverage.xml
          retention-days: 3

      - name: 📈 Coverage report
        if: matrix.coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-${{ matrix.os }}-py${{ matrix.python }}
          fail_ci_if_error: false
          verbose: true
          token: ${{ secrets.CODECOV_TOKEN }}

  # ============================================================================
  # 🏗️ Build Verification
  # ============================================================================

  build-package:
    name: 📦 Build Distribution
    needs: setup-environment  # Only needs setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v5

      - name: 🐍 Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 📦 Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: 💾 Restore cached environment
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
            .venv
          key: ${{ needs.setup-environment.outputs.cache-key }}
          restore-keys: |
            deps-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

      - name: 🏗️ Build package
        run: |
          echo "::group::Building distribution"
          uv build
          echo "::endgroup::"
          echo "::group::Package contents"
          ls -la dist/
          echo "::endgroup::"

      - name: 🔍 Check package with twine
        run: |
          pip install twine
          echo "::group::Twine check"
          twine check dist/*
          echo "::endgroup::"

      - name: 📤 Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: distribution-packages
          path: dist/
          retention-days: 3

  # ============================================================================
  # 🎯 Pre-commit Validation
  # ============================================================================

  pre-commit-check:
    name: 🪝 Pre-commit Hooks
    needs: setup-environment
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v5

      - name: 🐍 Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 📦 Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: 💾 Restore cached environment
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
            .venv
          key: ${{ needs.setup-environment.outputs.cache-key }}
          restore-keys: |
            deps-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

      - name: 💾 Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pre-commit
            ~/.local
          key: pre-commit-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('.pre-commit-config.yaml', '**/pyproject.toml', '**/uv.lock') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

      - name: 📦 Install dependencies
        run: |
          if [ ! -d ".venv" ]; then
            uv sync --frozen --all-extras
          fi
          uv pip install --system -e ".[dev]"

      - name: 🪝 Run pre-commit hooks
        env:
          SKIP: prettier,markdownlint,cspell,markdown-link-check,mkdocs-build,pytest
        run: |
          pre-commit run --all-files --show-diff-on-failure --color=always

  # ============================================================================
  # 📊 Results Summary
  # ============================================================================

  ci-summary:
    name: ✅ CI Summary
    if: always()
    needs:
      - quality-checks
      - security-scan
      - test-matrix
      - build-package
      - pre-commit-check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v5

      - name: 📊 Check job results
        id: check-results
        run: |
          # Function to check job result
          check_job() {
            local job_name="$1"
            local job_result="$2"
            local emoji="$3"

            if [ "$job_result" == "success" ]; then
              echo "$emoji ✅ $job_name: Success"
              return 0
            elif [ "$job_result" == "skipped" ]; then
              echo "$emoji ⏭️ $job_name: Skipped"
              return 0
            else
              echo "$emoji ❌ $job_name: Failed"
              return 1
            fi
          }

          # Initialize success flag
          all_success=true

          # Check all job results
          echo "## 📊 CI Pipeline Results"
          echo ""
          echo "### 🎯 Quality & Security"
          check_job "Quality Checks" "${{ needs.quality-checks.result }}" "🎯" || all_success=false
          check_job "Security Scan" "${{ needs.security-scan.result }}" "🛡️" || all_success=false
          echo ""
          echo "### 🧪 Testing & Build"
          check_job "Test Suite" "${{ needs.test-matrix.result }}" "🧪" || all_success=false
          check_job "Package Build" "${{ needs.build-package.result }}" "📦" || all_success=false
          echo ""
          echo "### 🪝 Validation"
          check_job "Pre-commit Hooks" "${{ needs.pre-commit-check.result }}" "🪝" || all_success=false
          echo ""

          # Set overall status
          if [ "$all_success" = true ]; then
            echo "## ✅ All checks passed successfully!"
            echo "ci_status=success" >> "$GITHUB_OUTPUT"
          else
            echo "## ❌ Some checks failed. Please review the results above."
            echo "ci_status=failure" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: 💬 Comment PR results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            // Get job statuses
            const jobs = {
              'quality-checks': '${{ needs.quality-checks.result }}',
              'security-scan': '${{ needs.security-scan.result }}',
              'test-matrix': '${{ needs.test-matrix.result }}',
              'build-package': '${{ needs.build-package.result }}',
              'pre-commit-check': '${{ needs.pre-commit-check.result }}'
            };

            // Function to get emoji for status
            function getStatusEmoji(status) {
              switch(status) {
                case 'success': return '✅';
                case 'failure': return '❌';
                case 'cancelled': return '🚫';
                case 'skipped': return '⏭️';
                default: return '⏳';
              }
            }

            // Build comment body
            let comment = `## 🚀 CI Pipeline Results\n\n`;
            comment += `Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n`;

            // Combined section
            comment += `### 🎯 CI Status\n`;
            comment += `| Check | Status |\n`;
            comment += `|-------|--------|\n`;
            comment += `| 🎯 Quality Checks | ${getStatusEmoji(jobs['quality-checks'])} |\n`;
            comment += `| 🛡️ Security Scan | ${getStatusEmoji(jobs['security-scan'])} |\n`;
            comment += `| 🧪 Test Suite | ${getStatusEmoji(jobs['test-matrix'])} |\n`;
            comment += `| 📦 Package Build | ${getStatusEmoji(jobs['build-package'])} |\n`;
            comment += `| 🪝 Pre-commit Hooks | ${getStatusEmoji(jobs['pre-commit-check'])} |\n`;
            comment += `\n`;

            // Overall status
            const allSuccess = Object.values(jobs).every(status =>
              status === 'success' || status === 'skipped'
            );

            if (allSuccess) {
              comment += `### ✅ All checks passed successfully!\n`;
            } else {
              comment += `### ❌ Some checks require attention\n`;
              comment += `Please review the failed checks above and make necessary corrections.\n`;
            }

            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('🚀 CI Pipeline Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: 🎉 Success notification
        if: steps.check-results.outputs.ci_status == 'success'
        run: |
          echo "::notice::✅ All CI checks passed successfully!"

      - name: ⚠️ Failure notification
        if: steps.check-results.outputs.ci_status == 'failure'
        run: |
          echo "::error::❌ CI pipeline failed. Please check the job results for details."
          exit 1
